<!doctype html>
<!--
ä¸­æ–‡æ‘˜è¦ï¼š
è¯¥é¡µé¢ç”¨äºå®æ—¶å±•ç¤ºè®­ç»ƒæ¼”ç¤ºï¼ˆTraining Demoï¼‰ã€‚
åŠŸèƒ½ï¼šé€šè¿‡å‰ç«¯æ§åˆ¶è®­ç»ƒå‚æ•°ï¼ˆepochsã€batch sizeã€lrã€deviceï¼‰ï¼Œåœ¨æµè§ˆå™¨ä¸­å®æ—¶æŸ¥çœ‹è®­ç»ƒæ—¥å¿—ã€Loss/Accuracy æ›²çº¿ä»¥åŠè®­ç»ƒè¿›åº¦æ¡ã€‚
è¿è¡Œï¼šå¯åŠ¨ webapp åè®¿é—® `/training_demo`ï¼ˆç¤ºä¾‹ï¼š`python -m mnist_pth_lab.webapp`ï¼‰ã€‚
-->
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>è®­ç»ƒæ¼”ç¤º â€” MNIST æ¨¡å‹è®­ç»ƒè¿‡ç¨‹å¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
      * { box-sizing: border-box; }
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial; color: #222; background: #f5f5f5; padding: 20px; }
      .container { max-width: 1200px; margin: 0 auto; }
      h1 { color: #333; margin-bottom: 10px; }
      .subtitle { color: #666; margin-bottom: 20px; }
      .control-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
      .control-section h2 { font-size: 18px; margin-top: 0; }
      .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      input, select { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
      button { padding: 10px 20px; border: none; border-radius: 4px; background: #0066cc; color: white; cursor: pointer; font-size: 14px; font-weight: 500; }
      button:hover { background: #0052a3; }
      button:disabled { background: #ccc; cursor: not-allowed; }
      .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
      .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
      .panel h3 { margin-top: 0; color: #333; }
      #logOutput { background: #1e1e1e; color: #d4d4d4; font-family: 'Courier New', monospace; font-size: 13px; height: 400px; overflow-y: auto; padding: 12px; border-radius: 4px; line-height: 1.5; }
      .log-line { margin: 2px 0; }
      .log-info { color: #6a9fb5; }
      .log-success { color: #4ec9b0; }
      .log-error { color: #f48771; }
      .log-warn { color: #dcdcaa; }
      #chartContainer { position: relative; height: 350px; }
      .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
      .stat-box { background: #f9f9f9; padding: 12px; border-left: 4px solid #0066cc; border-radius: 4px; }
      .stat-label { font-size: 12px; color: #666; }
      .stat-value { font-size: 24px; font-weight: bold; color: #333; }
      .progress-bar { background: #e0e0e0; height: 24px; border-radius: 4px; overflow: hidden; margin-top: 8px; }
      .progress-fill { background: linear-gradient(90deg, #0066cc, #00ccff); height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; font-size: 12px; color: white; font-weight: bold; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸš€ MNIST æ¨¡å‹è®­ç»ƒæ¼”ç¤º</h1>
      <p class="subtitle">å®æ—¶å¯è§†åŒ–æ¨¡å‹ä»åˆå§‹åŒ–åˆ°æƒé‡æ›´æ–°çš„å®Œæ•´è®­ç»ƒè¿‡ç¨‹</p>

      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="control-section">
        <h2>è®­ç»ƒé…ç½®</h2>
        <div class="controls">
          <div>
            <label>Epoch æ•°ï¼š</label>
            <input type="number" id="epochsInput" value="3" min="1" max="10">
          </div>
          <div>
            <label>Batch å¤§å°ï¼š</label>
            <input type="number" id="batchInput" value="64" min="16" max="256" step="16">
          </div>
          <div>
            <label>å­¦ä¹ ç‡ï¼š</label>
            <input type="number" id="lrInput" value="0.001" min="0.0001" max="0.1" step="0.0001">
          </div>
          <div>
            <label>è®¾å¤‡ï¼š</label>
            <select id="deviceInput">
              <option value="cpu">CPU</option>
              <option value="cuda">CUDA (GPU)</option>
            </select>
          </div>
          <button id="startBtn" onclick="startTraining()">â–¶ï¸ å¼€å§‹è®­ç»ƒ</button>
          <button id="resetBtn" onclick="resetTraining()">ğŸ”„ é‡ç½®</button>
        </div>
        <div class="progress-bar" id="progressBar">
          <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
        </div>
      </div>

      <!-- ä¸»è¦é¢æ¿ -->
      <div class="main-grid">
        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="panel">
          <h3>ğŸ“‹ è®­ç»ƒæ—¥å¿—</h3>
          <div id="logOutput"></div>
        </div>

        <!-- ç»Ÿè®¡ä¸æŒ‡æ ‡ -->
        <div class="panel">
          <h3>ğŸ“Š å®æ—¶æŒ‡æ ‡</h3>
          <div class="stats">
            <div class="stat-box">
              <div class="stat-label">å½“å‰ Epoch</div>
              <div class="stat-value" id="epochStat">-</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">å½“å‰ Batch</div>
              <div class="stat-value" id="batchStat">-</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">æœ€ä½³è®­ç»ƒå‡†ç¡®ç‡</div>
              <div class="stat-value" id="bestTrainAcc">-</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">æœ€ä½³éªŒè¯å‡†ç¡®ç‡</div>
              <div class="stat-value" id="bestValAcc">-</div>
            </div>
          </div>
          <h3 style="margin-top: 20px;">Loss & Accuracy æ›²çº¿</h3>
          <div id="chartContainer">
            <canvas id="metricsChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
      let chart = null;
      let pollInterval = null;

      function log(msg, type = 'info') {
        const logDiv = document.getElementById('logOutput');
        const line = document.createElement('div');
        line.className = 'log-line log-' + type;
        line.textContent = msg;
        logDiv.appendChild(line);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function updateStats(data) {
        document.getElementById('epochStat').textContent = data.is_running ? 
          `${data.current_epoch}/${data.total_epochs}` : '-';
        document.getElementById('batchStat').textContent = data.total_batches > 0 ?
          `${data.current_batch}/${data.total_batches}` : '-';
        
        if (data.train_acc.length > 0) {
          document.getElementById('bestTrainAcc').textContent = 
            (Math.max(...data.train_acc) * 100).toFixed(2) + '%';
        }
        if (data.val_acc.length > 0) {
          document.getElementById('bestValAcc').textContent = 
            (Math.max(...data.val_acc) * 100).toFixed(2) + '%';
        }

        // Update progress bar
        if (data.total_epochs > 0) {
          const progress = (data.current_epoch / data.total_epochs) * 100;
          document.getElementById('progressFill').style.width = progress + '%';
          document.getElementById('progressFill').textContent = Math.floor(progress) + '%';
        }

        // Update chart
        updateChart(data);
      }

      function updateChart(data) {
        const ctx = document.getElementById('metricsChart').getContext('2d');
        const epochs = Array.from({length: data.train_loss.length}, (_, i) => i + 1);

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: epochs,
            datasets: [
              {
                label: 'Train Loss',
                data: data.train_loss,
                borderColor: '#ff6b6b',
                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                yAxisID: 'y',
                tension: 0.3,
              },
              {
                label: 'Val Loss',
                data: data.val_loss,
                borderColor: '#ffa94d',
                backgroundColor: 'rgba(255, 169, 77, 0.1)',
                yAxisID: 'y',
                tension: 0.3,
              },
              {
                label: 'Train Acc',
                data: data.train_acc.map(x => x * 100),
                borderColor: '#51cf66',
                backgroundColor: 'rgba(81, 207, 102, 0.1)',
                yAxisID: 'y1',
                tension: 0.3,
              },
              {
                label: 'Val Acc',
                data: data.val_acc.map(x => x * 100),
                borderColor: '#339af0',
                backgroundColor: 'rgba(51, 154, 240, 0.1)',
                yAxisID: 'y1',
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
              y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Loss' } },
              y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Accuracy (%)' }, grid: { drawOnChartArea: false } },
            },
          },
        });
      }

      function pollProgress() {
        fetch('/training_demo/progress')
          .then(r => r.json())
          .then(data => {
            // Add new logs
            if (data.logs && data.logs.length > 0) {
              const logDiv = document.getElementById('logOutput');
              const currentLogs = logDiv.querySelectorAll('.log-line').length;
              for (let i = currentLogs; i < data.logs.length; i++) {
                const msg = data.logs[i];
                let type = 'info';
                if (msg.includes('ERROR')) type = 'error';
                else if (msg.includes('SUCCESS')) type = 'success';
                else if (msg.includes('Train') || msg.includes('Val')) type = 'warn';
                log(msg, type);
              }
            }
            updateStats(data);
            
            if (!data.is_running) {
              document.getElementById('startBtn').disabled = false;
              clearInterval(pollInterval);
            }
          });
      }

      function startTraining() {
        const epochs = parseInt(document.getElementById('epochsInput').value);
        const batchSize = parseInt(document.getElementById('batchInput').value);
        const lr = parseFloat(document.getElementById('lrInput').value);
        const device = document.getElementById('deviceInput').value;

        document.getElementById('startBtn').disabled = true;
        document.getElementById('logOutput').innerHTML = '';

        fetch('/training_demo/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ epochs, batch_size: batchSize, lr, device }),
        })
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            log('[ERROR] ' + data.error, 'error');
            document.getElementById('startBtn').disabled = false;
          } else {
            log('[SUCCESS] è®­ç»ƒå·²å¯åŠ¨ï¼Œå¼€å§‹æ”¶é›†æ—¥å¿—...', 'success');
            pollInterval = setInterval(pollProgress, 500);  // Poll every 500ms
            pollProgress();
          }
        });
      }

      function resetTraining() {
        fetch('/training_demo/reset', { method: 'POST' })
          .then(r => r.json())
          .then(data => {
            document.getElementById('logOutput').innerHTML = '';
            document.getElementById('epochStat').textContent = '-';
            document.getElementById('batchStat').textContent = '-';
            document.getElementById('bestTrainAcc').textContent = '-';
            document.getElementById('bestValAcc').textContent = '-';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressFill').textContent = '0%';
            if (chart) chart.destroy();
            log('[INFO] å·²é‡ç½®è®­ç»ƒçŠ¶æ€', 'info');
          });
      }
    </script>
  </body>
</html>
